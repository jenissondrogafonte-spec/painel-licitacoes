<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel PNCP - M√≥dulo 07</title>
    <style>
        :root { --primary: #003366; --accent: #0055aa; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: var(--bg); }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 10px; margin-top: 0; }
        .controls { margin-bottom: 25px; display: flex; align-items: center; gap: 15px; }
        button { background: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: var(--accent); transform: translateY(-1px); }
        #status { font-weight: bold; font-size: 14px; transition: 0.3s; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; overflow: hidden; border-radius: 8px; }
        th { background: var(--primary); color: white; padding: 15px; text-align: left; font-size: 14px; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; color: #333; }
        tr:hover { background: #f1f5f9; }
        
        .cnpj-btn { color: var(--accent); font-weight: bold; cursor: pointer; text-decoration: underline; background: none; border: none; padding: 0; }
        .badge { background: #e0e7ff; color: #4338ca; padding: 3px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>

<div class="container">
    <h2>üì° Monitor de Contrata√ß√µes PNCP (Lei 14.133)</h2>
    
    <div class="controls">
        <button onclick="buscarDadosDoGoverno()">Atualizar Dados 2025</button>
        <div id="status">Pronto para consultar</div>
    </div>

    <table>
        <thead>
            <tr>
                <th>Descri√ß√£o do Item</th>
                <th>Vencedor (CNPJ)</th>
                <th>Quantidade</th>
                <th>Vlr Unit√°rio</th>
                <th>Total Homologado</th>
            </tr>
        </thead>
        <tbody id="corpoTabela">
            <tr><td colspan="5" style="text-align: center; padding: 40px; color: #666;">Clique no bot√£o acima para carregar as informa√ß√µes.</td></tr>
        </tbody>
    </table>
</div>

<script>
async function buscarDadosDoGoverno() {
    const status = document.getElementById('status');
    const corpo = document.getElementById('corpoTabela');
    
    status.innerHTML = "‚è≥ Conectando √† API do Governo (via Proxy)...";
    status.style.color = "orange";

    // URL com filtros de 2025 e pagina√ß√£o (M√≥dulo 07 - Item 3)
    const dataInicio = "20250101";
    const dataFim = "20251231";
    const urlOriginal = `https://dadosabertos.compras.gov.br/modulo-contratacoes/3_consultarResultadoItensContratacoes_PNCP_14133?pagina=1&tamanhoPagina=15&dataInicial=${dataInicio}&dataFinal=${dataFim}`;
    
    // Proxy para evitar erro de CORS
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(urlOriginal)}`;

    try {
        const response = await fetch(proxyUrl);
        if (!response.ok) throw new Error("Falha na resposta do Proxy");
        
        const wrapper = await response.json();
        const data = JSON.parse(wrapper.contents);

        if (data.resultado && data.resultado.length > 0) {
            corpo.innerHTML = ""; // Limpa a tabela
            data.resultado.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="badge">ITEM</span> ${item.descricaoItem ? item.descricaoItem.substring(0, 80) : 'Sem descri√ß√£o'}...</td>
                    <td><button class="cnpj-btn" onclick="consultarFornecedor('${item.niFornecedorVencedor}')">${item.niFornecedorVencedor || 'N/A'}</button></td>
                    <td>${item.quantidadeHomologada || 0}</td>
                    <td>R$ ${item.valorUnitarioHomologado?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || '0,00'}</td>
                    <td><strong>R$ ${item.valorTotalHomologado?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || '0,00'}</strong></td>
                `;
                corpo.appendChild(row);
            });
            status.innerHTML = "‚úÖ Dados de 2025 carregados!";
            status.style.color = "green";
        } else {
            status.innerHTML = "‚ö†Ô∏è Nenhum dado encontrado para o per√≠odo de 2025.";
            status.style.color = "#856404";
        }
    } catch (error) {
        console.error("Erro na consulta:", error);
        status.innerHTML = "‚ùå Erro ao acessar a API. Tente novamente.";
        status.style.color = "red";
    }
}

async function consultarFornecedor(cnpj) {
    if (!cnpj || cnpj === 'N/A') return alert("CNPJ n√£o dispon√≠vel.");
    const cnpjLimpo = cnpj.replace(/\D/g, '');
    
    try {
        const res = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpjLimpo}`);
        const info = await res.json();
        
        if (res.ok) {
            alert(`üè¢ EMPRESA: ${info.razao_social}\nüìå NOME FANTASIA: ${info.nome_fantasia || 'N/A'}\nüìç CIDADE: ${info.municipio}/${info.uf}\n‚úÖ SITUA√á√ÉO: ${info.descricao_situacao_cadastral}`);
        } else {
            alert("Dados detalhados do CNPJ n√£o encontrados na Receita.");
        }
    } catch (e) {
        alert("Erro ao conectar com a base de dados de CNPJ.");
    }
}
</script>

</body>
</html>
