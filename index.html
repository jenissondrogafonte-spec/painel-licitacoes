<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel PNCP - Est√°vel</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1200px; margin: auto; }
        .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; background: #e9ecef; padding: 15px; border-radius: 8px; }
        input, button { padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        button { background: #003366; color: white; cursor: pointer; border: none; font-weight: bold; }
        button:disabled { background: #6c757d; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #003366; color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 5px; font-weight: bold; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #cce5ff; color: #004085; }
    </style>
</head>
<body>

<div class="card">
    <h2>üìä Monitor de Resultados PNCP</h2>
    <div id="status"></div>

    <div class="filters">
        <input type="date" id="dataIni" value="2025-01-01">
        <input type="date" id="dataFim" value="2025-01-05">
        <input type="text" id="orgao" placeholder="C√≥digo do √ìrg√£o">
        <button id="btn" onclick="buscar()">Pesquisar na API</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ID Contrata√ß√£o</th>
                <th>Fornecedor (CNPJ)</th>
                <th>Descri√ß√£o do Item</th>
                <th>Valor Total</th>
            </tr>
        </thead>
        <tbody id="tabelaBody">
            <tr><td colspan="4" style="text-align:center;">Selecione um per√≠odo curto para testar.</td></tr>
        </tbody>
    </table>
</div>

<script>
async function buscar() {
    const btn = document.getElementById('btn');
    const status = document.getElementById('status');
    const corpo = document.getElementById('tabelaBody');
    
    const d1 = document.getElementById('dataIni').value;
    const d2 = document.getElementById('dataFim').value;
    const orgao = document.getElementById('orgao').value.trim();

    btn.disabled = true;
    status.className = "alert info";
    status.innerHTML = "‚è≥ Conectando... O Governo pode levar at√© 30 segundos para responder.";
    corpo.innerHTML = "";

    // Endpoint 7 - M√≥dulo 10.7 (Resultados)
    let url = `https://dadosabertos.compras.gov.br/modulo-contratacoes/7_consultarResultadoItensContratacoes_PNCP_14133?pagina=1&tamanhoPagina=50&dataPublicacaoPncpInicial=${d1}&dataPublicacaoPncpFinal=${d2}`;
    if (orgao) url += `&codigoOrgao=${orgao}`;

    try {
        const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        const response = await fetch(proxy);
        const wrapper = await response.json();
        
        if (!wrapper.contents) throw new Error("Resposta vazia");
        
        const data = JSON.parse(wrapper.contents);
        const lista = data.resultado || [];

        if (lista.length === 0) {
            status.className = "alert error";
            status.innerHTML = "‚ö†Ô∏è API respondeu, mas n√£o h√° dados para este filtro.";
            corpo.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Nenhum dado encontrado.</td></tr>";
        } else {
            status.innerHTML = `‚úÖ ${lista.length} itens carregados com sucesso!`;
            lista.forEach(item => {
                // Preven√ß√£o de erro para campos nulos
                const id = item.idContratacaoPNCP || 'N/A';
                const cnpj = item.niFornecedor || item.niFornecedorVencedor || 'N/A';
                const desc = item.descricaoItem || 'Sem descri√ß√£o';
                const valorRaw = item.valorTotalHomologado || item.valorEstimado || 0;
                const valorFormatado = valorRaw.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'});

                corpo.innerHTML += `
                    <tr>
                        <td><strong>${id}</strong></td>
                        <td>${cnpj}<br><small>${item.nomeRazaoSocialFornecedor || ''}</small></td>
                        <td>${desc}</td>
                        <td>${valorFormatado}</td>
                    </tr>`;
            });
        }
    } catch (err) {
        status.className = "alert error";
        status.innerHTML = "‚ùå Erro de Conex√£o. O servidor do governo est√° sobrecarregado. Tente um intervalo de apenas 2 dias.";
        console.error(err);
    } finally {
        btn.disabled = false;
    }
}
</script>
</body>
</html>
