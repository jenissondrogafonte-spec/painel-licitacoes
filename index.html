<script>
document.getElementById('form-busca').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const uasg = document.getElementById('uasg').value.trim();
    const numero = document.getElementById('numero').value.trim();
    const objeto = document.getElementById('objeto').value.trim();
    
    // DEBUG: Mostra exatamente o que foi digitado
    console.log('üîç Digitado:', {uasg, numero, objeto});
    
    if (!uasg && !numero && !objeto) {
        return alert('Informe filtro!');
    }
    
    const params = new URLSearchParams({ limit: '50' });
    if (uasg) params.append('uasg', uasg);
    if (numero) params.append('numero_aviso', numero);
    if (objeto) params.append('objeto', objeto);
    
    const apiUrl = `http://compras.dados.gov.br/licitacoes/v1/licitacoes.json?${params}`;
    console.log('üåê URL chamada:', apiUrl); // DEBUG URL
    
    const proxyUrls = ['https://api.allorigins.win/raw?url=' + encodeURIComponent(apiUrl)];
    
    const loading = document.getElementById('loading');
    const tabela = document.getElementById('tabela-resultados');
    const info = document.getElementById('info');
    
    loading.style.display = 'block';
    tabela.style.display = 'none';
    info.style.display = 'none';
    
    let data;
    for (let proxyUrl of proxyUrls) {
        try {
            const response = await fetch(proxyUrl);
            data = await response.json();
            console.log('üìä Resposta API:', data); // DEBUG resposta
            break;
        } catch (err) {
            console.error('‚ùå Erro proxy:', err);
        }
    }
    
    loading.style.display = 'none';
    
    info.innerHTML = `üîç Busca: UASG=<b>${uasg}</b> N¬∫=<b>${numero}</b> Objeto=<b>${objeto}</b><br>üìä URL: <a href="${apiUrl}" target="_blank">${apiUrl}</a><br>${data?.resultado?.length || 0} resultados`;
    info.style.display = 'block';
    
    if (!data?.resultado?.length) return;
    
    const tbody = tabela.querySelector('tbody');
    tbody.innerHTML = '';
    data.resultado.slice(0, 20).forEach(lic => {
        tbody.innerHTML += `
            <tr>
                <td>${lic.numero_aviso || '-'}</td>
                <td>${lic.uasg || '-'}</td>
                <td>${lic.objeto?.substring(0, 80) || '-'}</td>
                <td>${lic.data_publicacao || '-'}</td>
                <td>${lic.modalidade || '-'}</td>
            </tr>`;
    });
    tabela.style.display = 'table';
});
</script>
